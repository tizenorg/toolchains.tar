From ccbd4fcef3bf9863dadd9e75e5bbc7384335bf5b Mon Sep 17 00:00:00 2001
Message-Id: <ccbd4fcef3bf9863dadd9e75e5bbc7384335bf5b.1302249265.git.yan.i.li@intel.com>
From: Yan Li <yan.i.li@intel.com>
Date: Fri, 8 Apr 2011 15:28:01 +0800
Subject: [PATCH] Fix BMC#6661 - CVE-2007-4476 Buffer overflow in the safer_name_suffix to cause DoS


Signed-off-by: Yan Li <yan.i.li@intel.com>
---
 lib/paxnames.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/lib/paxnames.c b/lib/paxnames.c
index 3ca8bfa..6b1e688 100644
--- a/lib/paxnames.c
+++ b/lib/paxnames.c
@@ -121,7 +121,9 @@ safer_name_suffix (char const *file_name, bool link_target, bool absolute_names)
 
       if (prefix_len)
 	{
-	  char *prefix = alloca (prefix_len + 1);
+	  char *prefix = malloc (prefix_len + 1);
+	  if (!prefix)
+	      FATAL_ERROR ((0, errno, _("%s: malloc failure"), __func__));
 	  memcpy (prefix, file_name, prefix_len);
 	  prefix[prefix_len] = '\0';
 
@@ -134,6 +136,7 @@ safer_name_suffix (char const *file_name, bool link_target, bool absolute_names)
 	      };
 	      WARN ((0, 0, _(diagnostic[link_target]), prefix));
 	    }
+	  free (prefix);
 	}
     }
 
-- 
1.7.2.5

